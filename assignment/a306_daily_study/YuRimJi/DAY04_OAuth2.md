# OAuth2 인증 시스템

## 기본 개념
> 사용자의 인증(Authentication)과 권한 부여(Authorization)를 위한 업계 표준 프로토콜. 제3자 애플리케이션이 사용자의 민감한 정보를 직접 다루지 않고도 필요한 리소스에 안전하게 접근할 수 있게 해주는 프레임워크

## 주요 구성 요소
### Resource Owner
- 보호된 리소스에 대한 접근 권한을 가진 사용자
- 일반적으로 서비스를 사용하는 최종 사용자
- 애플리케이션의 기능 접근을 승인하는 주체

### Client
- Resource Owner를 대신하여 보호된 리소스에 접근하려는 애플리케이션
- 웹, 모바일 앱, 데스크톱 애플리케이션 등이 해당
- OAuth 제공자에게 등록된 고유한 Client ID와 Client Secret 보유

### Resource Server
- 보호된 자원을 호스팅하는 서버
- 액세스 토큰을 검증하여 리소스 접근 허용
- API 엔드포인트를 제공하여 클라이언트의 요청 처리

### Authorization Server
- 클라이언트의 인증과 권한 부여를 처리하는 서버
- 다음과 같은 주요 기능 제공:
    - 사용자 인증
    - 권한 부여 코드 발급
    - 액세스 토큰 발급
    - 리프레시 토큰 관리


<br>

## OAuth2 인증 흐름
> **OAuth2 로그인 요청 → 사용자 인증 → 권한부여 요청 → 인증코드 발급 → 액세스토큰 요청 → 액세스토큰 발급 → 백엔드 처리**

## Spring Security 통합
- Security Configuration 에 해야하는 것들 
    - 보안 관련 전반적인 설정
    - URL 별 접근 권한 설정
    - CSRF 보호 설정
    - 세션 관리 정책 설정
    - 필터 체인 구성
- UserDetails 구현
    - 스프링 시큐리티가 사용하는 사용자 정보 인터페이스
    - 사용자 기본 정보 제공
    - 권한 정보 제공
    - 계정 상태 정보 제공
- PasswordEncoder 설정
    - DB에 비밀번호 암호화 후 저장하기 위해 사용

## 필터 체인 구성

### 1. JWT 검증 (모든 요청)
- 요청 헤더의 JWT 토큰 확인
- 토큰 유효성 검증
- 인증 정보 설정

### 2. OAuth2 처리(소셜 로그인)
- Authorization Code 수신
- Access Token 교환 -> Spring Security OAuth2 Client에 의해 자동으로 처리
- 사용자 정보 조회 -> CustomOAuth2UserService에서 처리

### 3. 인증 정보 관리
- SecurityContextHolder에 인증 정보 저장
- 인증된 사용자 정보 유지
- 요청 처리 완료 후 정리


## 보안 고려 사항
### 1. 토큰 만료 정책
- Access Token: 짧은 유효기간 설정 (보통 15-30분) → 현재 우리 코드 1시간
- Refresh Token: 적절한 유효기간 설정 (보통 2주-1달) → 현재 우리 코드 1주
- 토큰 자동 갱신 메커니즘 구현 → JwtVerificationFilter에서 구현함
- 토큰 폐기 정책 수립

### 2. 토큰 암호화
- JWT 서명을 위한 강력한 비밀키 사용 → 우리 코드 64글자 암호로 설정
- HS256 이상의 암호화 알고리즘 사용 → 우리 코드 HS256(HMAC with SHA-256) 알고리즘 사용
    - HS256 알고리즘이란?
        1. JWT(JSON Web Token)에서 가장 널리 사용되는 서명 알고리즘
        
        ## **작동 방식**
        
        - HMAC(Hash-based Message Authentication Code) 기반
        - SHA-256 해시 함수 사용
        - 대칭키(symmetric key) 암호화 방식
        - 동일한 비밀키로 서명 생성과 검증 수행
        
        ## **보안 강도**
        
        - 256비트 해시 값 생성
        - 충돌 저항성이 강함
        - 비밀키가 노출되지 않는 한 안전
        
        ## **장단점**
        
        ## **장점**
        
        - 구현이 간단
        - 빠른 처리 속도
        - 적은 컴퓨팅 리소스 사용
        - 생성된 토큰 크기가 작음
        
        ## **단점**
        
        - 비밀키를 공유해야 함
        - 키 관리의 어려움
        - 서버 간 확장성 제한
        - 키 노출 시 전체 시스템 위험
        
        ## **사용 시 고려사항**
        
        - 충분히 긴 비밀키 사용 (최소 256비트)
        - 안전한 키 저장 및 전송
        - 정기적인 키 교체
        - HTTPS 사용 필수
- 토큰 저장 시 HttpOnly 쿠키 사용 → 사용함
